#* @vtlvariable name="ctx" type="org.kevoree.modeling.kotlin.generator.GenerationContext" *#
#* @vtlvariable name="helper" type="org.kevoree.modeling.kotlin.generator.ProcessorHelperClass" *#
#* @vtlvariable name="rootElement" type="org.eclipse.emf.ecore.EClass" *#
#* @vtlvariable name="elemToLoad" type="org.eclipse.emf.ecore.EClass" *#
#* @vtlvariable name="allEClass" type="org.eclipse.emf.ecore.EClass" *#

package ${helper.fqn($ctx, $ctx.getBasePackageForUtilitiesGeneration())}.loader

import java.io.File
import java.io.FileReader
import java.io.FileInputStream
import java.io.InputStream
import java.io.Reader
import java.io.StringReader
import java.io.InputStreamReader
import com.google.gson.stream.JsonReader
import com.google.gson.stream.JsonToken

class JSONModelLoader : ${helper.fqn($ctx, $ctx.getBasePackageForUtilitiesGeneration())}.loader.ModelLoader {

    val mainFactory = ${helper.fqn($ctx, $ctx.getBasePackageForUtilitiesGeneration())}.factory.MainFactory()

    override fun loadModelFromString(str: String) : List<${helper.fqn($ctx,$rootElement)}>? {
        return deserialize(StringReader(str))
    }

    override fun loadModelFromPath(file: File) : List<${helper.fqn($ctx,$rootElement)}>? {
        return loadModelFromStream(FileInputStream(file))
    }

    override fun loadModelFromStream(inputStream: InputStream) : List<${helper.fqn($ctx,$rootElement)}>? {
        return deserialize(InputStreamReader(inputStream))
    }

    private fun deserialize(topreader : Reader): List<${helper.fqn($ctx,$rootElement)}> {
        var reader : JsonReader = JsonReader(topreader)
        val context = LoadingContext()
        while(reader.hasNext() && (reader.peek() != JsonToken.END_DOCUMENT)) {
            reader.beginObject()
            val nextKey = reader.nextName()
            if(nextKey.equals("eClass")) {
                val eclassValue = reader.nextString()
                if(eclassValue.equals("${helper.fqn($ctx,$rootElement.getEPackage())}:$rootElement.getName()")) {
                    load$rootElement.getName()(reader, context, "/")
                    if(context.$rootElement.getName().substring(0,1).toLowerCase()$rootElement.getName().substring(1) != null) {
                        context.loaded_${rootElement.getName().substring(0,1).toLowerCase()}${rootElement.getName().substring(1)}.add(context.$rootElement.getName().substring(0,1).toLowerCase()$rootElement.getName().substring(1)!!)
                    }
                } else {
                    System.err.println("Unknown root type '" + eclassValue + "'. Loading aborted.")
                }
            } else {
                System.err.println("Ignored key '" + nextKey + "' while looking for the root element 'eClass'")
            }
            reader.endObject()
        }
        for(res in context.resolvers) {res()}
        return context.loaded_$rootElement.getName().substring(0,1).toLowerCase()$rootElement.getName().substring(1)
    }

    private fun unescapeJSON(src : String) : String {
        var builder : StringBuilder? = null
        var i : Int = 0
        while (i < src.length) {
            val c = src[i]
            if(c == '&') {
                if(builder == null) {
                    builder = StringBuilder(src.substring(0,i))
                }
                if(src[i+1]=='a') {
                    builder?.append("'")
                    i = i+6
                } else if(src[i+1]=='q') {
                    builder?.append("\"")
                    i = i+6
                } else {
                    System.err.println("Could not unescaped chain:" + src[i] + src[i+1])
                }
            } else {
                if(builder != null) {
                    builder?.append(c)
                }
                i++
            }
        }

        if(builder != null) {
            return builder.toString()
        } else {
            return src
        }
    }

#foreach($eClazz in $allEClass)
    #if( $eClazz.getEReferenceType().isAbstract() || $eClazz.getEReferenceType().isInterface())

    #else
        #generateLoadMethod($eClazz)
    #end
#end

#macro( generateLoadMethod $elemToLoad )
    private fun load$elemToLoad.getName()(reader : JsonReader, context : LoadingContext, elementId: String) : $helper.fqn($ctx, $elemToLoad) {

        val modelElem = mainFactory.get${elemToLoad.getEPackage().getName().substring(0,1).toUpperCase()}${elemToLoad.getEPackage().getName().substring(1)}Factory().create$elemToLoad.getName()()
        #if($elemToLoad == $rootElement)
        val loaded$elemToLoad.getName().substring(0,1).toLowerCase()$elemToLoad.getName().substring(1)Size = context.loaded_${elemToLoad.getName().substring(0,1).toLowerCase()}${elemToLoad.getName().substring(1)}.size()
        context.$rootElement.getName().substring(0,1).toLowerCase()$elemToLoad.getName().substring(1) = modelElem
        context.map.put("/" + loaded$elemToLoad.getName().substring(0,1).toLowerCase()$elemToLoad.getName().substring(1)Size, context.$elemToLoad.getName().substring(0,1).toLowerCase()$elemToLoad.getName().substring(1)!!)
        #else
        context.map.put(elementId, modelElem)
        #end

        while (reader.hasNext()) {
            val nextName = reader.nextName()
            when(nextName) {
            #foreach($att in $elemToLoad.getEAllAttributes())
                #set($methName = "set" + $att.getName().substring(0, 1).toUpperCase() + $att.getName().substring(1))
                #if($helper.convertType($att.getEAttributeType()).equals("Int"))
                "$att.getName()" -> {modelElem.$methName(reader.nextInt())}
                #elseif($helper.convertType($att.getEAttributeType()).equals("Boolean"))
                "$att.getName()" -> {modelElem.$methName(reader.nextBoolean())}
                #elseif($helper.convertType($att.getEAttributeType()).equals("Double"))
                "$att.getName()" -> {modelElem.$methName(reader.nextDouble())}
                #elseif($helper.convertType($att.getEAttributeType()).equals("Long"))
                "$att.getName()" -> {modelElem.$methName(reader.nextLong())}
                #elseif($att.getEAttributeType().getClass().getName().toLowerCase().contains("eenum"))
                "$att.getName()" -> {modelElem.$methName(${helper.fqn($ctx,$att.getEAttributeType())}.valueOf(reader.nextString()!!))}
                #else
                "$att.getName()" -> {modelElem.$methName(unescapeJSON(reader.nextString()!!))}
                #end
            #end
            #foreach($ref in $elemToLoad.getEAllReferences())
                #if($ref.isContainment())
                "$ref.getName()" -> { ##is containement and many
                    #if($ref.isMany())
                    reader.beginArray()
                    while(reader.hasNext()){
                    #end
                        reader.beginObject()
                            #if($ref.isMany())
                                    #if($elemToLoad == $rootElement)
                                    val i = context.elementsCount.get(elementId+ loaded$elemToLoad.getName().substring(0,1).toLowerCase()$elemToLoad.getName().substring(1)Size + "/@$ref.getName()") ?: 0
                                    val $ref.getName()ElementId = elementId + loaded$elemToLoad.getName().substring(0,1).toLowerCase()$elemToLoad.getName().substring(1)Size + "/@$ref.getName()." + i
                                    #else
                                    val i = context.elementsCount.get(elementId + "/@$ref.getName()") ?: 0
                                    val $ref.getName()ElementId = elementId + "/@$ref.getName()." + i
                                    #end
                            #else
                                val $ref.getName()ElementId = elementId + "/@$ref.getName()"
                            #end
                            #set($concreteSubTypes=$helper.getAllConcreteSubTypes($ref.getEReferenceType()))
                            #set($isConcret= (!$ref.getEReferenceType().isAbstract()) && (!$ref.getEReferenceType().isInterface()))
                            #if(!( ($isConcret && $concreteSubTypes.size() == 0) || (!$isConcret && $concreteSubTypes.size() == 1) ))
                            val nextKey = reader.nextName()
                            if(nextKey.equals("eClass")) {
                            val eclassValue = reader.nextString()
                                when(eclassValue) {

                                    #if($isConcret)
                                    "$helper.fqn($ctx, $ref.getEReferenceType().getEPackage()):$ref.getEReferenceType().getName()" -> {
                                        val loadedElem = load$ref.getEReferenceType().getName()(reader, context, $ref.getName()ElementId)
                                        modelElem.#if($ref.isMany())add#{else}set#{end}$ref.getName().substring(0,1).toUpperCase()$ref.getName().substring(1)(loadedElem)
                                    }
                                    #end
                                    #foreach($concreteType in $concreteSubTypes)
                                    "$helper.fqn($ctx, $concreteType.getEPackage()):$concreteType.getName()" -> {
                                        val loadedElem = load$concreteType.getName()(reader, context, $ref.getName()ElementId)
                                        modelElem.#if($ref.isMany())add#{else}set#{end}$ref.getName().substring(0,1).toUpperCase()$ref.getName().substring(1)(loadedElem)
                                    }
                                    #end
                                    else -> {
                                        System.err.println("Unknown root type '" + eclassValue + "'. Loading aborted.")
                                    }
                                }
                            } else {
                                System.err.println("Ignored key '" + nextKey + "' while looking for the root element 'eClass'")
                            }
                            #else
                                #if($concreteSubTypes.size() == 1)
                                    val loadedElem = load$concreteSubTypes.get(0).getName()(reader, context, $ref.getName()ElementId)
                                #else
                                    val loadedElem = load$ref.getEReferenceType().getName()(reader, context, $ref.getName()ElementId)
                                #end
                                modelElem.#if($ref.isMany())add#{else}set#{end}$ref.getName().substring(0,1).toUpperCase()$ref.getName().substring(1)(loadedElem)
                            #end
                            #if($ref.isMany())
                                #if($elemToLoad == $rootElement)
                                context.elementsCount.put(elementId + loaded$elemToLoad.getName().substring(0,1).toLowerCase()$elemToLoad.getName().substring(1)Size + "/@$ref.getName()",i+1)
                                #else
                                context.elementsCount.put(elementId + "/@$ref.getName()",i+1)
                                #end
                            #end
                        reader.endObject()
                    #if($ref.isMany())
                    }
                    reader.endArray()
                    #end
                }
                #{else}
                "$ref.getName()" -> {##is not containement
                    #if($ref.isMany())
                    reader.beginArray()
                    while(reader.hasNext()) {
                    #end
                        val xmiRef = reader.nextString()!!
                        val adjustedRef = if(xmiRef.startsWith("//")){"/0" + xmiRef.substring(1)} else { xmiRef}
                        val ref = context.map.get(adjustedRef)
                        if( ref != null) {
                            #if($ref.isMany())
                            modelElem.add$ref.getName().substring(0,1).toUpperCase()$ref.getName().substring(1)(ref as $helper.fqn($ctx, $ref.getEReferenceType()))
                            #else
                            modelElem.set$ref.getName().substring(0,1).toUpperCase()$ref.getName().substring(1)(ref as $helper.fqn($ctx, $ref.getEReferenceType()))
                            #end
                        } else {
                            context.resolvers.add({()->
                            var $ref.getName()Ref = context.map.get(adjustedRef)
                            if($ref.getName()Ref == null){
                                $ref.getName()Ref = context.${rootElement.getName().substring(0,1).toLowerCase()}${rootElement.getName().substring(1)}!!.findByPath(adjustedRef)
                            }

                            if($ref.getName()Ref != null) {
                                #if($ref.isMany())
                                modelElem.add$ref.getName().substring(0,1).toUpperCase()$ref.getName().substring(1)($ref.getName()Ref as $helper.fqn($ctx, $ref.getEReferenceType()))
                                #else
                                modelElem.set$ref.getName().substring(0,1).toUpperCase()$ref.getName().substring(1)($ref.getName()Ref as $helper.fqn($ctx, $ref.getEReferenceType()))
                                #end
                            } else { throw Exception("KMF Load error : $ref.getEReferenceType().getName() not found in map ! xmiRef:" + adjustedRef)}
                            })
                        }
                    #if($ref.isMany())
                    }
                    reader.endArray()
                    #end
                }
                #end
            #end
                "eClass" -> { reader.nextString() }
                else -> {System.out.println("Tag unrecognized: " + nextName + " in $elemToLoad.getName()")}
            }
        }
        return modelElem
    }

#end

}